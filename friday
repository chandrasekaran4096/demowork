package com.dataloader;

import java.io.File;
import java.util.Map;

public class Main {
    
    private static final String DEFAULT_PROPERTIES_FILENAME = "config.properties";
    private static final String DEFAULT_JSON_FILENAME = "table-config.json";
    
    public static void main(String[] args) {
        System.out.println("=== Excel to MSSQL Data Loader ===\n");
        
        try {
            // Validate arguments
            if (args.length < 1) {
                printUsage();
                System.exit(1);
            }
            
            String tableKey = args[0];
            String configPropertiesPath = null;
            
            System.out.println("Processing table key: " + tableKey + "\n");
            
            // Determine properties file path
            if (args.length >= 2) {
                configPropertiesPath = args[1];
                System.out.println("Using properties file from argument: " + configPropertiesPath);
                
                File configPropertiesFile = new File(configPropertiesPath);
                if (!configPropertiesFile.exists()) {
                    System.err.println("ERROR: Configuration properties file not found: " + configPropertiesPath);
                    System.exit(1);
                }
            } else {
                configPropertiesPath = findPropertiesFile();
                if (configPropertiesPath == null) {
                    System.err.println("ERROR: Configuration properties file not found.");
                    System.err.println("Searched location: " + new File(DEFAULT_PROPERTIES_FILENAME).getAbsolutePath());
                    System.err.println("\nPlease either:");
                    System.err.println("  - Place 'config.properties' in the application directory, or");
                    System.err.println("  - Specify the properties file path: java -jar ExcelToMSSQL.jar <tableKey> <config.properties>");
                    System.exit(1);
                }
                System.out.println("Found properties file: " + configPropertiesPath);
            }
            
            // Load embedded JSON configuration
            String configJsonPath = findJsonConfig();
            if (configJsonPath == null) {
                System.err.println("ERROR: table-config.json not found in application directory");
                System.err.println("Expected location: " + new File(DEFAULT_JSON_FILENAME).getAbsolutePath());
                System.exit(1);
            }
            
            // Load configuration
            System.out.println("Loading configuration from:");
            System.out.println("  JSON: " + configJsonPath);
            System.out.println("  Properties: " + configPropertiesPath);
            ConfigManager config = new ConfigManager(configJsonPath, configPropertiesPath);
            
            // Display connection info
            System.out.println("\nDatabase Connection:");
            System.out.println("  Server: " + config.getServer() + ":" + config.getPort());
            System.out.println("  Database: " + config.getDatabaseName());
            System.out.println("  Username: " + config.getUsername());
            
            // Get specific table configuration by key
            TableConfig tableConfig = config.getTableConfigByKey(tableKey);
            
            if (tableConfig == null) {
                System.err.println("\nERROR: Table key '" + tableKey + "' not found in configuration");
                System.err.println("Available keys: " + config.getAvailableKeys());
                System.exit(1);
            }
            
            System.out.println("\n=====================================");
            System.out.println("Processing Table: " + tableConfig.getFullTableName());
            System.out.println("Schema: " + tableConfig.getSchemaName());
            System.out.println("Excel File: " + tableConfig.getExcelFilePath());
            System.out.println("=====================================\n");
            
            // Initialize handlers
            DatabaseHandler dbHandler = new DatabaseHandler(config);
            ExcelHandler excelHandler = new ExcelHandler();
            
            try {
                // Validate Excel file
                File excelFile = new File(tableConfig.getExcelFilePath());
                if (!excelFile.exists()) {
                    System.err.println("ERROR: Excel file not found: " + tableConfig.getExcelFilePath());
                    System.exit(1);
                }
                
                // Read Excel data
                System.out.println("Reading Excel file...");
                java.util.List<Map<String, Object>> data = excelHandler.readExcel(
                    tableConfig.getExcelFilePath(),
                    tableConfig.getSheetName(),
                    tableConfig.getHeaderRowIndex(),
                    tableConfig.getColumnLetters()
                );
                
                if (data.isEmpty()) {
                    System.out.println("WARNING: No data found in Excel file");
                    System.exit(0);
                }
                
                System.out.println("Found " + data.size() + " rows to process");
                
                // Insert data into database
                dbHandler.insertData(data, tableConfig);
                
                System.out.println("\n=====================================");
                System.out.println("=== Process Completed Successfully ===");
                System.out.println("Table: " + tableConfig.getFullTableName());
                System.out.println("Rows processed: " + data.size());
                System.out.println("=====================================");
                
            } catch (Exception e) {
                System.err.println("\nERROR processing table '" + tableConfig.getFullTableName() + "': " + e.getMessage());
                e.printStackTrace();
                System.exit(1);
            } finally {
                // Cleanup
                dbHandler.close();
            }
            
            System.out.println("\n=== Process completed ===");
            
        } catch (Exception e) {
            System.err.println("\nFATAL ERROR: " + e.getMessage());
            e.printStackTrace();
            System.exit(1);
        }
    }
    
    private static String findPropertiesFile() {
        File currentDir = new File(DEFAULT_PROPERTIES_FILENAME);
        if (currentDir.exists()) {
            return currentDir.getAbsolutePath();
        }
        return null;
    }
    
    private static String findJsonConfig() {
        File jsonFile = new File(DEFAULT_JSON_FILENAME);
        if (jsonFile.exists()) {
            return jsonFile.getAbsolutePath();
        }
        return null;
    }
    
    private static void printUsage() {
        System.err.println("Usage: java -jar ExcelToMSSQL.jar <tableKey> [config.properties]");
        System.err.println("\nExamples:");
        System.err.println("  java -jar ExcelToMSSQL.jar EmpData");
        System.err.println("  java -jar ExcelToMSSQL.jar ProdInventory");
        System.err.println("  java -jar ExcelToMSSQL.jar EmpData config.properties");
        System.err.println("\nDescription:");
        System.err.println("  tableKey          - The key from table-config.json (e.g., EmpData, ProdInventory)");
        System.err.println("  config.properties - Optional path to properties file (default: config.properties)");
        System.err.println("\nRequired Files:");
        System.err.println("  - table-config.json (in application directory)");
        System.err.println("  - config.properties (in application directory or specified path)");
    }
}


package com.dataloader;

import com.google.gson.Gson;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import java.io.FileInputStream;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.Set;

public class ConfigManager {
    
    private JsonObject config;
    private Properties dbProperties;
    
    public ConfigManager(String configJsonPath, String configPropertiesPath) throws IOException {
        // Load properties file
        loadProperties(configPropertiesPath);
        
        // Load JSON config
        Gson gson = new Gson();
        try (FileReader reader = new FileReader(configJsonPath)) {
            config = gson.fromJson(reader, JsonObject.class);
        }
        
        validateConfig();
    }
    
    private void loadProperties(String propertiesPath) throws IOException {
        dbProperties = new Properties();
        try (FileInputStream fis = new FileInputStream(propertiesPath)) {
            dbProperties.load(fis);
        }
        
        // Validate required properties
        String[] required = {"database.server", "database.port", "database.name", 
                           "database.username", "database.password"};
        for (String prop : required) {
            if (!dbProperties.containsKey(prop) || 
                dbProperties.getProperty(prop).trim().isEmpty()) {
                throw new RuntimeException("Missing or empty required property: " + prop);
            }
        }
    }
    
    private void validateConfig() {
        if (config == null) {
            throw new RuntimeException("Configuration file is empty or invalid");
        }
        
        if (config.size() == 0) {
            throw new RuntimeException("No table configurations defined in config");
        }
    }
    
    public String getServer() {
        return dbProperties.getProperty("database.server");
    }
    
    public int getPort() {
        return Integer.parseInt(dbProperties.getProperty("database.port"));
    }
    
    public String getDatabaseName() {
        return dbProperties.getProperty("database.name");
    }
    
    public String getUsername() {
        return dbProperties.getProperty("database.username");
    }
    
    public String getPassword() {
        return dbProperties.getProperty("database.password");
    }
    
    public boolean isCreateDatabaseIfNotExists() {
        String value = dbProperties.getProperty("database.createIfNotExists", "true");
        return Boolean.parseBoolean(value);
    }
    
    public int getBatchSize() {
        String value = dbProperties.getProperty("database.batchSize", "1000");
        return Integer.parseInt(value);
    }
    
    public Set<String> getAvailableKeys() {
        return config.keySet();
    }
    
    public TableConfig getTableConfigByKey(String key) {
        if (!config.has(key)) {
            return null;
        }
        
        JsonObject tableJson = config.getAsJsonObject(key);
        TableConfig tableConfig = new TableConfig();
        
        // Required fields
        if (!tableJson.has("tableName") || !tableJson.has("excelFilePath") || !tableJson.has("columns")) {
            throw new RuntimeException("Table config '" + key + "' missing required fields (tableName, excelFilePath, columns)");
        }
        
        tableConfig.setTableName(tableJson.get("tableName").getAsString());
        tableConfig.setExcelFilePath(tableJson.get("excelFilePath").getAsString());
        
        // Schema name (using objectName from JSON, default to "dbo")
        if (tableJson.has("objectName") && !tableJson.get("objectName").isJsonNull()) {
            tableConfig.setSchemaName(tableJson.get("objectName").getAsString());
        } else if (tableJson.has("schemaName") && !tableJson.get("schemaName").isJsonNull()) {
            tableConfig.setSchemaName(tableJson.get("schemaName").getAsString());
        } else {
            tableConfig.setSchemaName("dbo"); // default schema
        }
        
        // Optional fields
        if (tableJson.has("sheetName")) {
            tableConfig.setSheetName(tableJson.get("sheetName").getAsString());
        }
        
        if (tableJson.has("headerRowIndex")) {
            tableConfig.setHeaderRowIndex(tableJson.get("headerRowIndex").getAsInt());
        }
        
        if (tableJson.has("createTableIfNotExists")) {
            tableConfig.setCreateTableIfNotExists(tableJson.get("createTableIfNotExists").getAsBoolean());
        }
        
        if (tableJson.has("truncateBeforeInsert")) {
            tableConfig.setTruncateBeforeInsert(tableJson.get("truncateBeforeInsert").getAsBoolean());
        }
        
        // Parse columns
        JsonArray columnsJson = tableJson.getAsJsonArray("columns");
        List<ColumnConfig> columns = new ArrayList<>();
        
        for (int j = 0; j < columnsJson.size(); j++) {
            JsonObject colJson = columnsJson.get(j).getAsJsonObject();
            ColumnConfig column = new ColumnConfig();
            
            if (!colJson.has("columnName") || !colJson.has("dataType") || !colJson.has("excelColumnLetter")) {
                throw new RuntimeException("Column at index " + j + " in table '" + tableConfig.getTableName() + "' missing required fields");
            }
            
            column.setColumnName(colJson.get("columnName").getAsString());
            column.setDataType(colJson.get("dataType").getAsString());
            column.setExcelColumnLetter(colJson.get("excelColumnLetter").getAsString());
            
            if (colJson.has("isPrimaryKey")) {
                column.setPrimaryKey(colJson.get("isPrimaryKey").getAsBoolean());
            }
            
            if (colJson.has("isNullable")) {
                column.setNullable(colJson.get("isNullable").getAsBoolean());
            }
            
            if (colJson.has("maxLength")) {
                column.setMaxLength(colJson.get("maxLength").isJsonNull() ? null : colJson.get("maxLength").getAsInt());
            }
            
            if (colJson.has("precision")) {
                column.setPrecision(colJson.get("precision").getAsInt());
            }
            
            if (colJson.has("scale")) {
                column.setScale(colJson.get("scale").getAsInt());
            }
            
            columns.add(column);
        }
        
        tableConfig.setColumns(columns);
        return tableConfig;
    }
}