$(document).ready(function () {
  const $cartContainer = $("#cartContainer");
  const $grandTotal = $("#grandTotal");
  const $selectedCount = $("#selectedCount");
  const $placeOrder = $("#placeOrder");
  
  function toast(message, color = "#ff7f50") {
    Toastify({
      text: message,
      duration: 3000,
      close: true,
      gravity: "top",
      position: "right",
      backgroundColor: color,
      stopOnFocus: true,
    }).showToast();
  }

  function loadCart() {
    $.ajax({
      url: "http://localhost:8080/BiteBudddy/CartApiServlet",
      method: "GET",
      dataType: "json",
      success: function (data) {
        renderCart(data);
        updateTotals();
      },
      error: function (xhr) {
        if (xhr.status === 401) {
          Swal.fire({
            title: "Login Required",
            text: "Please log in to view your cart.",
            icon: "warning",
            confirmButtonColor: "#ff7f50",
          }).then(() => {
            window.location.href = "login.html";
          });
        }
        else if (xhr.status === 403) {
          Swal.fire({
            title: "Access Denied",
            text: "You don't have permission to access this page.",
            icon: "error",
            confirmButtonText: "Back to Login"
          }).then(() => {
            window.location.href = "login.html";
          });
        }
        else {
          $cartContainer.html(`<p class="text-center text-red-400">Failed to load cart.</p>`);
        }
      },
    });
  }

  function renderCart(items) {
    $cartContainer.empty();
    if (!items || items.length === 0) {
      $cartContainer.html(`<p class="text-center text-gray-400">Your cart is empty.</p>`);
      return;
    }

    items.forEach(item => {
      const itemTotal = (item.price * item.quantity).toFixed(2);
      const card = $(`
        <div class="bg-white/5 border border-white/6 rounded-2xl p-4 flex flex-col md:flex-row items-center justify-between gap-4 hover:scale-[1.02] transition-transform">
          <div class="flex items-center gap-4 w-full md:w-3/4">
            <input type="checkbox" class="select-item w-5 h-5 accent-orange-500" data-id="${item.cartId}">
            <img src="${item.imagePath || '/assets/no-image.png'}" alt="${item.itemName}" class="cart-img shadow-lg">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-orange-300">${item.itemName}</h3>
              <p class="text-sm text-gray-300">â‚¹${item.price.toFixed(2)} Each</p>
              <p class="text-sm text-gray-400 mt-1">Restaurant: ${item.name}</p>
            </div>
          </div>

          <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
            <div class="flex items-center gap-2 bg-white/3 rounded-lg px-3 py-1">
              <button class="decrease px-3 py-1 rounded bg-white/6 hover:bg-white/10" data-id="${item.cartId}">-</button>
              <span class="quantity font-semibold" id="qty-${item.cartId}">${item.quantity}</span>
              <button class="increase px-3 py-1 rounded bg-white/6 hover:bg-white/10" data-id="${item.cartId}">+</button>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-300">Total</p>
              <p class="text-lg font-bold"><span id="total-${item.cartId}">${itemTotal}</span></p>
              <button class="remove mt-2 text-sm text-red-400 hover:text-red-500" data-id="${item.cartId}">Remove</button>
            </div>
          </div>
        </div>
      `);
      $cartContainer.append(card);
    });
  }

 

  function updateTotals() {
    let total = 0;
    let count = 0;
    $(".select-item:checked").each(function () {
      const id = $(this).data("id");
      const qty = parseInt($(`#qty-${id}`).text(), 10);
      const priceText = $(`#total-${id}`).text();
      const price = parseFloat(priceText) / (qty || 1);
      total += price * qty;
      count++;
    });
    $grandTotal.text(total.toFixed(2));
    $selectedCount.text(count);
    $placeOrder.prop("disabled", count === 0);
  }

  $cartContainer.on("click", ".increase", function () {
    const cartId = $(this).data("id");
    const $qtySpan = $(`#qty-${cartId}`);
    let qty = parseInt($qtySpan.text(), 10);
    qty++;
    updateQuantityAjax(cartId, qty);
  });

  $cartContainer.on("click", ".decrease", function () {
    const cartId = $(this).data("id");
    const $qtySpan = $(`#qty-${cartId}`);
    let qty = parseInt($qtySpan.text(), 10);
    if (qty > 1) {
      qty--;
      updateQuantityAjax(cartId, qty);
    }
  });

$cartContainer.on("click", ".remove", function () {
    const cartId = $(this).data("id");

    Swal.fire({
      title: "Remove Item?",
      text: "Do you really want to remove this item from your cart?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#ef4444",
      cancelButtonColor: "#6b7280",
      confirmButtonText: "Yes, remove it!"
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: "http://localhost:8080/BiteBudddy/CartApiServlet?action=delete",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ cart_id: cartId }),
          success: function (res) {
            if (res.status === "success") {
              toast("Item removed from cart!", "#4caf50");
              loadCart();
              if (typeof CartBadge !== 'undefined') {
              CartBadge.refresh();
            }
            } else {
              toast(res.message || "Failed to remove item.", "#ff5252");
            }
          },
          error: function () {
            toast("Server error while removing item.", "#ff5252");
          }
        });
      }
    });
});

  $cartContainer.on("change", ".select-item", updateTotals);

function updateQuantityAjax(cartId, qty) {
    $.ajax({
      url: "http://localhost:8080/BiteBudddy/CartApiServlet?action=update",
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify({ cart_id: cartId, quantity: qty }),
      success: function (res) {
        if (res.status === "success") {
          $(`#qty-${cartId}`).text(qty);
          if (res.itemTotal !== undefined) {
            $(`#total-${cartId}`).text(res.itemTotal.toFixed(2));
          } else {
            loadCart();
          }
          updateTotals();
          if (typeof CartBadge !== 'undefined') {
          CartBadge.refresh();
        }
          toast("Quantity updated!", "#4caf50");
          
        } else {
          toast(res.message || "Failed to update quantity.", "#ff5252");
        }
      },
      error: function () {
        toast("Error updating quantity.", "#ff5252");
      }
    });
}
  $("#placeOrder").on("click", function () {
    const selectedItems = $(".select-item:checked");
    if (selectedItems.length === 0) {
      toast("Please select at least one item.", "#ff5252");
      return;
    }
    $("#orderModal").removeClass("hidden");
  });

  $("#cancelOrder").on("click", function () {
    $("#orderModal").addClass("hidden");
    resetAllValidation();
  });

  const validators = {
    address: (val) => {
      if (!val || val.trim().length < 10) return "Address must be at least 10 characters";
      if (val.trim().length > 200) return "Address too long (max 200 characters)";
      return "";
    },
    
    upiId: (val) => {
      if (!val || val.trim().length === 0) return "UPI ID is required";
      const upiPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z]{3,}$/;
      if (!upiPattern.test(val.trim())) return "Invalid UPI ID format (e.g., Chandra@paytm)";
      return "";
    },
    
    cardNumber: (val) => {
      if (!val || val.trim().length === 0) return "Card number is required";
      const cleaned = val.replace(/\s/g, '');
      if (!/^\d{16}$/.test(cleaned)) return "Card number must be 16 digits";
      return "";
    },
    
    cardHolderName: (val) => {
      if (!val || val.trim().length === 0) return "Card holder name is required";
      if (val.trim().length < 3) return "Name must be at least 3 characters";
      if (!/^[a-zA-Z\s]+$/.test(val)) return "Name can only contain letters";
      return "";
    },
    
      expiryDate: (val) => {
        if (!val || val.trim().length === 0) return "Expiry date is required";
        const pattern = /^(0[1-9]|1[0-2])\/([0-9]{2})$/;
        if (!pattern.test(val)) return "Format must be MM/YY";
        
        const [month, year] = val.split('/');
        const expiry = new Date(2000 + parseInt(year), parseInt(month) - 1);
        const now = new Date();
        
        if (expiry < now) return "Card has expired";
        return "";
      },
    
    cvv: (val) => {
      if (!val || val.trim().length === 0) return "CVV is required";
      if (!/^\d{3,4}$/.test(val)) return "CVV must be 3 or 4 digits";
      return "";
    }
  };

  function showValidation(inputId, errorMsg) {
    const $input = $(`#${inputId}`); 
    const $errorSpan = $input.next('.error-message');
    
    $input.removeClass('border-red-500 border-green-500 border-gray-700');
    
    if (errorMsg) {
      $input.addClass('border-red-500');
      if ($errorSpan.length) {
        $errorSpan.text(errorMsg).show();
      } else {
        $input.after(`<small class="error-message text-red-400 text-xs mt-1 block">${errorMsg}</small>`);
      }
    } else if ($input.val().trim() !== '') {
      $input.addClass('border-green-500');
      if ($errorSpan.length) {
        $errorSpan.hide();
      }
    } else {
      $input.addClass('border-gray-700');
      if ($errorSpan.length) {
        $errorSpan.hide();
      }
    }
  }

  function resetValidation(inputId) {
    const $input = $(`#${inputId}`);
    const $errorSpan = $input.next('.error-message');
    
    $input.removeClass('border-red-500 border-green-500').addClass('border-gray-700');
    if ($errorSpan.length) {
      $errorSpan.hide();
    }
  }

  function resetAllValidation() {
    ['shippingAddress', 'upiId', 'cardNumber', 'cardHolderName', 'expiryDate', 'cvv'].forEach(id => {
      resetValidation(id);
    });
  }

  $("#shippingAddress").on("input", function() {
    const val = $(this).val();
    if (val.length === 0) {
      resetValidation("shippingAddress");
    } else {
      const error = validators.address(val);
      showValidation("shippingAddress", error);
    }
  });

  $("#upiId").on("input", function() {
    const val = $(this).val();
    if (val.length === 0) {
      resetValidation("upiId");
    } else {
      const error = validators.upiId(val);
      showValidation("upiId", error);
    }
  });

  $("#cardNumber").on("input", function() {
    let val = $(this).val().replace(/\s/g, '');
    let formatted = val.match(/.{1,4}/g)?.join(' ') || val;
    $(this).val(formatted);
    
    if (val.length === 0) {
      resetValidation("cardNumber");
    } else {
      const error = validators.cardNumber(val);
      showValidation("cardNumber", error);
    }
  });

  $("#cardHolderName").on("input", function() {
    const val = $(this).val().toUpperCase();
    $(this).val(val);
    
    if (val.length === 0) {
      resetValidation("cardHolderName");
    } else {
      const error = validators.cardHolderName(val);
      showValidation("cardHolderName", error);
    }
  });

  $("#expiryDate").on("input", function() {
    let val = $(this).val().replace(/\D/g, '');
    if (val.length >= 2) {
      val = val.slice(0, 2) + '/' + val.slice(2, 4);
    }
    $(this).val(val);
    
    if (val.length === 0) {
      resetValidation("expiryDate");
    } else {
      const error = validators.expiryDate(val);
      showValidation("expiryDate", error);
    }
  });

  $("#cvv").on("input", function() {
    let val = $(this).val().replace(/\D/g, '').slice(0, 4);
    $(this).val(val);
    
    if (val.length === 0) {
      resetValidation("cvv");
    } else {
      const error = validators.cvv(val);
      showValidation("cvv", error);
    }
  });

  // Payment mode change
  $("#paymentMode").on("change", function () {
    const selectedPayment = $(this).val();
    const upiInput = $("#upi-input");
    const cardModal = $("#card-modal");

    resetValidation("upiId");
    resetValidation("cardNumber");
    resetValidation("cardHolderName");
    resetValidation("expiryDate");
    resetValidation("cvv");

    upiInput.addClass("hidden");
    cardModal.addClass("hidden");

    if (selectedPayment === "UPI") {
      upiInput.removeClass("hidden");
      $("#upiId").val('').focus();
    } else if (selectedPayment === "Credit/Debit Card") {
      cardModal.removeClass("hidden");
      $("#cardNumber").val('').focus();
    }
  });

  // Card modal handlers
  $("#cancelCard").on("click", function () {
    $("#card-modal").addClass("hidden");
    $("#paymentMode").val("");
    
    $("#cardNumber, #cardHolderName, #expiryDate, #cvv").val("");
    resetValidation("cardNumber");
    resetValidation("cardHolderName");
    resetValidation("expiryDate");
    resetValidation("cvv");
  });

  $("#submitCard").on("click", function () {
    const cardNumber = $("#cardNumber").val().trim();
    const cardHolderName = $("#cardHolderName").val().trim();
    const expiryDate = $("#expiryDate").val().trim();
    const cvv = $("#cvv").val().trim();

    const errors = {
      cardNumber: validators.cardNumber(cardNumber),
      cardHolderName: validators.cardHolderName(cardHolderName),
      expiryDate: validators.expiryDate(expiryDate),
      cvv: validators.cvv(cvv)
    };

    showValidation("cardNumber", errors.cardNumber);
    showValidation("cardHolderName", errors.cardHolderName);
    showValidation("expiryDate", errors.expiryDate);
    showValidation("cvv", errors.cvv);

    if (Object.values(errors).some(e => e !== "")) {
      toast("Please fix all card validation errors", "#ff5252");
      return;
    }

    $("#card-modal").addClass("hidden");
    toast("Card details confirmed", "#4caf50");
  });

  $("#confirmOrder").on("click", function () {
    const address = $("#shippingAddress").val().trim();
    const payment = $("#paymentMode").val();

    // Validate address and payment
    const addressError = validators.address(address);
    const paymentError = !payment ? "Please select a payment method" : "";

    showValidation("shippingAddress", addressError);

    if (addressError || paymentError) {
      if (paymentError) {
        toast(paymentError, "#ff5252");
      } else {
        toast("Please fix all validation errors", "#ff5252");
      }
      return;
    }

    if (payment === "UPI") {
      const upiError = validators.upiId($("#upiId").val().trim());
      showValidation("upiId", upiError);
      
      if (upiError) {
        toast("Please enter a valid UPI ID", "#ff5252");
        return;
      }
    } else if (payment === "Credit/Debit Card") {
      const cardNumber = $("#cardNumber").val().trim();
      const cardHolderName = $("#cardHolderName").val().trim();
      const expiryDate = $("#expiryDate").val().trim();
      const cvv = $("#cvv").val().trim();

      const cardErrors = {
        cardNumber: validators.cardNumber(cardNumber),
        cardHolderName: validators.cardHolderName(cardHolderName),
        expiryDate: validators.expiryDate(expiryDate),
        cvv: validators.cvv(cvv)
      };

      if (Object.values(cardErrors).some(e => e !== "")) {
        toast("Please verify your card details", "#ff5252");
        return;
      }
    }

    // get selected cart items
    const selectedIds = [];
    $(".select-item:checked").each(function () {
      selectedIds.push($(this).data("id"));
    });

    if (selectedIds.length === 0) {
      toast("No items selected for order", "#ff5252");
      return;
    }

    $.ajax({
      url: "http://localhost:8080/BiteBudddy/OrderServlet",
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        cartIds: selectedIds,
        address: address,
        paymentMode: payment
      }),
      dataType: "json",
      success: function (res) {
        if (res.status === "success" && res.data === true) {
          $("#orderModal").addClass("hidden");
          
          Swal.fire({
            title: "Order Placed!",
            text: res.message || "Your order has been placed successfully.",
            icon: "success",
            confirmButtonColor: "#ff7f50",
            confirmButtonText: "Continue Shopping"
          }).then(() => {
            window.location.href = "restaurant.html";
          });
        } else {
          toast(res.message || "Failed to place order.", "#ff5252");
        }
      },
      error: function (xhr, status, error) {
        console.error("Order error:", error);
        toast("Server error while placing order.", "#ff5252");
      }
    });
  });

  $("#logoutBtn").click(function() {
    Swal.fire({
      title: "Logout Confirmation",
      text: "Are you sure you want to log out?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#f97316",
      cancelButtonColor: "#6b7280",
      confirmButtonText: "Yes, Logout"
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: "http://localhost:8080/BiteBudddy/user",
          type: "POST",
          data: { action: "logout" },
          dataType: "json",
          success: function(res) {
            if (res.status === "success") {
              Swal.fire({
                icon: "success",
                title: "Logged out!",
                text: res.message,
                showConfirmButton: false,
                timer: 1500
              });
              setTimeout(() => {
                window.location.href = res.redirect;
              }, 1600);
            } else {
              Swal.fire("Error", res.message, "error");
            }
          },
          error: function() {
            Swal.fire("Error", "Server error during logout", "error");
          }
        });
      }
    });
  });

  loadCart();
});
