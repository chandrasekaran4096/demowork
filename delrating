package com.bite.dao;

import java.sql.*;
import org.apache.log4j.Logger;
import com.bite.util.DBConnection;
import com.bite.util.DBUtil;
import com.bite.util.LoggerUtil;

/**
 * Base DAO class providing reusable database operations
 * with proper exception handling and resource management
 */
public abstract class BaseDAO {
    protected final Logger logger;
    
    protected BaseDAO(Class<?> clazz) {
        this.logger = LoggerUtil.getLogger(clazz);
    }
    
    /**
     * Execute a query with proper resource management
     */
    protected <T> T executeQuery(String sql, ResultSetHandler<T> handler, Object... params) {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DBConnection.getConnection();
            if (conn == null) {
                logger.error("Failed to get database connection");
                throw new SQLException("Database connection is null");
            }
            
            ps = conn.prepareStatement(sql);
            setParameters(ps, params);
            rs = ps.executeQuery();
            
            return handler.handle(rs);
            
        } catch (SQLException e) {
            logger.error("Error executing query: " + sql, e);
            throw new DAOException("Database query failed", e);
        } finally {
            DBUtil.closeResources(rs, ps, conn);
        }
    }
    
    /**
     * Execute an update/insert/delete with proper resource management
     */
    protected int executeUpdate(String sql, Object... params) {
        Connection conn = null;
        PreparedStatement ps = null;
        
        try {
            conn = DBConnection.getConnection();
            if (conn == null) {
                logger.error("Failed to get database connection");
                throw new SQLException("Database connection is null");
            }
            
            ps = conn.prepareStatement(sql);
            setParameters(ps, params);
            
            return ps.executeUpdate();
            
        } catch (SQLException e) {
            logger.error("Error executing update: " + sql, e);
            throw new DAOException("Database update failed", e);
        } finally {
            DBUtil.closeResources(ps, conn);
        }
    }
    
    /**
     * Execute an insert and return generated key
     */
    protected int executeInsertWithGeneratedKey(String sql, Object... params) {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DBConnection.getConnection();
            if (conn == null) {
                logger.error("Failed to get database connection");
                throw new SQLException("Database connection is null");
            }
            
            ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
            setParameters(ps, params);
            ps.executeUpdate();
            
            rs = ps.getGeneratedKeys();
            if (rs.next()) {
                return rs.getInt(1);
            }
            
            return -1;
            
        } catch (SQLException e) {
            logger.error("Error executing insert: " + sql, e);
            throw new DAOException("Database insert failed", e);
        } finally {
            DBUtil.closeResources(rs, ps, conn);
        }
    }
    
    /**
     * Execute transaction with automatic commit/rollback
     */
    protected <T> T executeTransaction(TransactionCallback<T> callback) {
        Connection conn = null;
        
        try {
            conn = DBConnection.getConnection();
            if (conn == null) {
                logger.error("Failed to get database connection");
                throw new SQLException("Database connection is null");
            }
            
            conn.setAutoCommit(false);
            
            T result = callback.execute(conn);
            
            conn.commit();
            return result;
            
        } catch (Exception e) {
            logger.error("Transaction failed", e);
            if (conn != null) {
                try {
                    conn.rollback();
                    logger.info("Transaction rolled back successfully");
                } catch (SQLException ex) {
                    logger.error("Error rolling back transaction", ex);
                }
            }
            throw new DAOException("Transaction execution failed", e);
        } finally {
            if (conn != null) {
                try {
                    conn.setAutoCommit(true);
                } catch (SQLException e) {
                    logger.error("Error resetting auto-commit", e);
                }
            }
            DBUtil.closeConnection(conn);
        }
    }
    
    /**
     * Set parameters in prepared statement
     */
    private void setParameters(PreparedStatement ps, Object... params) throws SQLException {
        for (int i = 0; i < params.length; i++) {
            ps.setObject(i + 1, params[i]);
        }
    }
    
    /**
     * Functional interface for result set handling
     */
    @FunctionalInterface
    protected interface ResultSetHandler<T> {
        T handle(ResultSet rs) throws SQLException;
    }
    
    /**
     * Functional interface for transaction handling
     */
    @FunctionalInterface
    protected interface TransactionCallback<T> {
        T execute(Connection conn) throws Exception;
    }
    
    /**
     * Custom DAO exception
     */
    public static class DAOException extends RuntimeException {
        public DAOException(String message, Throwable cause) {
            super(message, cause);
        }
    }
}