package com.bite.controller;

import com.bite.dao.OrderDAO;
import com.bite.model.ResponseMessage;
import com.bite.model.User;
import com.google.gson.Gson;
import org.apache.log4j.Logger;
import com.bite.util.LoggerUtil;
import javax.servlet.http.*;
import java.io.IOException;

public class RateDeliveryPersonServlet extends HttpServlet {
    private static final Logger logger = LoggerUtil.getLogger(RateDeliveryPersonServlet.class);
    private final OrderDAO orderDao = new OrderDAO();
    private final Gson gson = new Gson();

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        logger.info("POST /RateDeliveryPerson request received");
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");
        
        try {
            HttpSession session = req.getSession(false);
            if (session == null || session.getAttribute("user") == null) {
                logger.warn("Unauthorized delivery rating attempt");
                resp.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
                resp.getWriter().write(gson.toJson(
                    new ResponseMessage<>("error", "Not authenticated", false)
                ));
                return;
            }
            
            User user = (User) session.getAttribute("user");
            if (!"customer".equalsIgnoreCase(user.getRole())) {
                logger.warn("Non-customer attempted to rate delivery");
                resp.setStatus(HttpServletResponse.SC_FORBIDDEN);
                resp.getWriter().write(gson.toJson(
                    new ResponseMessage<>("error", "Only customers can rate deliveries", false)
                ));
                return;
            }
            
            String orderIdStr = req.getParameter("orderId");
            String ratingStr = req.getParameter("rating");
            String review = req.getParameter("review");
            
            if (orderIdStr == null || ratingStr == null) {
                logger.warn("Missing required parameters");
                resp.setStatus(HttpServletResponse.SC_BAD_REQUEST);
                resp.getWriter().write(gson.toJson(
                    new ResponseMessage<>("error", "Order ID and rating are required", false)
                ));
                return;
            }
            
            int orderId = Integer.parseInt(orderIdStr);
            int rating = Integer.parseInt(ratingStr);
            
            logger.info("Rating delivery person for order: " + orderId + " with rating: " + rating);
            
            // Validate rating
            if (rating < 1 || rating > 5) {
                logger.warn("Invalid rating value: " + rating);
                resp.getWriter().write(gson.toJson(
                    new ResponseMessage<>("error", "Rating must be between 1 and 5", false)
                ));
                return;
            }
            
            // Check if already rated
            Integer existingRating = orderDao.getDeliveryPersonRating(orderId);
            if (existingRating != null && existingRating > 0) {
                logger.warn("Delivery person already rated for order: " + orderId);
                resp.getWriter().write(gson.toJson(
                    new ResponseMessage<>("error", "You have already rated this delivery", false)
                ));
                return;
            }
            
            // Check if order can be rated (must be delivered)
            if (!orderDao.canRateDelivery(orderId)) {
                logger.warn("Order not eligible for rating: " + orderId);
                resp.getWriter().write(gson.toJson(
                    new ResponseMessage<>("error", "Order must be delivered to rate", false)
                ));
                return;
            }
            
            // Update delivery person rating
            boolean success = orderDao.updateDeliveryPersonRating(orderId, rating, review);
            
            if (success) {
                logger.info("Delivery rating submitted successfully for order: " + orderId);
                resp.getWriter().write(gson.toJson(
                    new ResponseMessage<>("success", "Delivery rating submitted successfully", true)
                ));
            } else {
                logger.warn("Failed to submit delivery rating for order: " + orderId);
                resp.getWriter().write(gson.toJson(
                    new ResponseMessage<>("error", "Failed to submit rating", false)
                ));
            }
            
        } catch (NumberFormatException e) {
            logger.error("Invalid number format in rating request", e);
            resp.setStatus(HttpServletResponse.SC_BAD_REQUEST);
            resp.getWriter().write(gson.toJson(
                new ResponseMessage<>("error", "Invalid order ID or rating", false)
            ));
        } catch (Exception e) {
            logger.error("Error submitting delivery rating: " + e.getMessage(), e);
            resp.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
            resp.getWriter().write(gson.toJson(
                new ResponseMessage<>("error", "Server error", false)
            ));
        }
    }
}