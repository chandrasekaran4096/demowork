package com.bite.controller;

import com.bite.model.DashboardResponse;
import com.bite.model.Restaurant;
import com.bite.model.RestaurantDashboardModel;
import com.bite.model.User;
import com.bite.service.AdminService;
import com.google.gson.GsonBuilder;
import com.google.gson.Gson;

import javax.servlet.ServletException;
import javax.servlet.http.*;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.*;

public class AdminDashboardServlet extends HttpServlet {
    private final AdminService adminService = new AdminService();
    //private final Gson gson = new Gson();
    private final Gson gson = new GsonBuilder()
            .serializeNulls()
            .setDateFormat("yyyy-MM-dd HH:mm:ss")
            .create();


    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        resp.setContentType("application/json;charset=UTF-8");
        //HttpSession session = req.getSession(false);

//        // Optional: require admin login
//        if (session == null || session.getAttribute("user") == null) {
//            resp.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
//            resp.getWriter().write("{\"error\":\"Not authenticated\"}");
//            return;
//        }

        // Check role if User object has role
        //Object userObj = session.getAttribute("user");
//        if (userObj != null) {
//            try {
//                // Assuming your User model has getRole()
//                com.bite.model.User u = (com.bite.model.User) userObj;
//                if (!"admin".equalsIgnoreCase(u.getRole())) {
//                    resp.setStatus(HttpServletResponse.SC_FORBIDDEN);
//                    resp.getWriter().write("{\"error\":\"Requires admin role\"}");
//                    return;
//                }
//            } catch (Exception ignored) { /* continue if no role check desired */ }
//        }

        String action = req.getParameter("action");
        if (action == null) action = "dashboard";

        try (PrintWriter out = resp.getWriter()) {
            if ("dashboard".equals(action)) {
                // Already implemented
            	DashboardResponse dashboard = adminService.getDashboard();
                out.write(gson.toJson(dashboard));

            } else if ("restaurants".equals(action)) {
                List<RestaurantDashboardModel> restaurants = adminService.getAllRestaurants();
                Map<String, Object> result = new HashMap<>();
                result.put("restaurants", restaurants);
                out.write(gson.toJson(result));
            } else if ("viewRestaurant".equals(action)) {
                int restaurantId = Integer.parseInt(req.getParameter("restaurantId"));
                Restaurant restaurant = adminService.getRestaurantDetails(restaurantId);

                if (restaurant == null) {
                    out.print(gson.toJson(new ErrorResponse("Restaurant not found")));
                    return;
                }

                String json = gson.toJson(restaurant);
                out.print(json);
            }
            else if("users".equals(action)){
            	
            	System.out.println("Msg from users in admindash boaras");
            	List<User> users = adminService.getAllUsers();
                Map<String, Object> data = new HashMap<>();
                data.put("users", users);

                String jsonResponse = gson.toJson(data);
                resp.getWriter().write(jsonResponse);
            }
            else if ("viewUser".equals(action)) {
                int userId = Integer.parseInt(req.getParameter("userId"));
                Map<String, Object> result = adminService.getUserDetails(userId);
                resp.getWriter().write(gson.toJson(result));
            }
            else {
            	resp.setStatus(HttpServletResponse.SC_BAD_REQUEST);
                out.write("{\"error\":\"Unknown action\"}");
            }
            
        } catch (Exception ex) {
            ex.printStackTrace();
            resp.setStatus(500);
            resp.getWriter().write("{\"error\":\"Server error\"}");
        }
    }
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        String action = request.getParameter("action");

        try {
            if ("toggleRestaurantStatus".equals(action)) {
                int restaurantId = Integer.parseInt(request.getParameter("restaurantId"));
                String status = request.getParameter("status");
                boolean updated = adminService.toggleRestaurantStatus(restaurantId, status);
                response.getWriter().write("{\"success\":" + updated + "}");

            } else if ("deleteRestaurant".equals(action)) {
                int restaurantId = Integer.parseInt(request.getParameter("restaurantId"));
                boolean deleted = adminService.deleteRestaurant(restaurantId);
                response.getWriter().write("{\"success\":" + deleted + "}");
            }

        } catch (Exception e) {
            e.printStackTrace();
            response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
            response.getWriter().write("{\"error\":\"Server error occurred\"}");
        }
    }
    
    
    private static class ErrorResponse {
        String error;

        public ErrorResponse(String error) {
            this.error = error;
        }
    }
}
