package com.bite.controller;

import com.bite.model.DashboardResponse;
import com.bite.model.Restaurant;
import com.bite.model.RestaurantDashboardModel;
import com.bite.model.User;
import com.bite.service.AdminService;
import com.google.gson.GsonBuilder;
import com.google.gson.Gson;

import javax.servlet.ServletException;
import javax.servlet.http.*;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.*;

public class AdminDashboardServlet extends HttpServlet {
    private final AdminService adminService = new AdminService();
    private final Gson gson = new GsonBuilder()
            .serializeNulls()
            .setDateFormat("yyyy-MM-dd HH:mm:ss")
            .create();

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        resp.setContentType("application/json;charset=UTF-8");
        String action = req.getParameter("action");
        if (action == null) action = "dashboard";

        try (PrintWriter out = resp.getWriter()) {
            if ("dashboard".equals(action)) {
                DashboardResponse dashboard = adminService.getDashboard();
                out.write(gson.toJson(dashboard));

            } else if ("restaurants".equals(action)) {
                List<RestaurantDashboardModel> restaurants = adminService.getAllRestaurants();
                Map<String, Object> result = new HashMap<>();
                result.put("restaurants", restaurants);
                out.write(gson.toJson(result));

            } else if ("viewRestaurant".equals(action)) {
                int restaurantId = Integer.parseInt(req.getParameter("restaurantId"));
                Restaurant restaurant = adminService.getRestaurantDetails(restaurantId);

                if (restaurant == null) {
                    out.print(gson.toJson(new ErrorResponse("Restaurant not found")));
                    return;
                }

                out.print(gson.toJson(restaurant));

            } else if ("users".equals(action)) {
                System.out.println("Msg from users in admindashboard");
                List<User> users = adminService.getAllUsers();
                Map<String, Object> data = new HashMap<>();
                data.put("users", users);
                resp.getWriter().write(gson.toJson(data));

            } else if ("viewUser".equals(action)) {
                int userId = Integer.parseInt(req.getParameter("userId"));
                Map<String, Object> result = adminService.getUserDetails(userId);
                resp.getWriter().write(gson.toJson(result));

            } else {
                resp.setStatus(HttpServletResponse.SC_BAD_REQUEST);
                out.write("{\"error\":\"Unknown action\"}");
            }

        } catch (Exception ex) {
            ex.printStackTrace();
            resp.setStatus(500);
            resp.getWriter().write("{\"error\":\"Server error\"}");
        }
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        String action = request.getParameter("action");
        response.setContentType("application/json;charset=UTF-8");
        PrintWriter out = response.getWriter();

        try {
            if ("toggleRestaurantStatus".equals(action)) {
                int restaurantId = Integer.parseInt(request.getParameter("restaurantId"));
                String status = request.getParameter("status");
                boolean updated = adminService.toggleRestaurantStatus(restaurantId, status);
                response.getWriter().write("{\"success\":" + updated + "}");

            } else if ("deleteRestaurant".equals(action)) {
                int restaurantId = Integer.parseInt(request.getParameter("restaurantId"));
                boolean deleted = adminService.deleteRestaurant(restaurantId);
                response.getWriter().write("{\"success\":" + deleted + "}");

            } 
            // âœ… NEW: Toggle User Block/Unblock Logic
            else if ("toggleUserStatus".equals(action)) {
                int userId = Integer.parseInt(request.getParameter("userId"));
                String currentStatus = request.getParameter("currentStatus");

                boolean updated = adminService.toggleUserStatus(userId, currentStatus);

                Map<String, Object> jsonResponse = new HashMap<>();
                if (updated) {
                    jsonResponse.put("success", true);
                    jsonResponse.put("message", currentStatus.equalsIgnoreCase("Active")
                            ? "User has been blocked successfully."
                            : "User has been unblocked successfully.");
                } else {
                    jsonResponse.put("success", false);
                    jsonResponse.put("message", "Failed to update user status.");
                }

                out.print(gson.toJson(jsonResponse));
            }

        } catch (Exception e) {
            e.printStackTrace();
            response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
            out.write("{\"error\":\"Server error occurred\"}");
        }
    }

    private static class ErrorResponse {
        String error;
        public ErrorResponse(String error) {
            this.error = error;
        }
    }
}